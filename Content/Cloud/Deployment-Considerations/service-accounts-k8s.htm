<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
  <head>
    </head>
  <body>
    <h1><MadCap:concept term="Cloud"/>Service Accounts in Kubernetes</h1>
    <p>As part of the installation of the <MadCap:variable name="Product-Names.cloud_agent_short"/>, the Helm chart automatically creates the following service accounts: </p>
    <ul>
      <li>
        <MadCap:xref href="#agent-service-account">Service Account for the [%=Product-Names.cloud_agent_short%]</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#pods-service-account">Service Account for the Event Broker Pods</MadCap:xref>
      </li>
    </ul>
    <h2><a name="agent-service-account"/>Service Account for the <MadCap:variable name="Product-Names.cloud_agent_short"/></h2>
    <MadCap:snippetBlock src="../../Resources/Snippets/CloudDeployment/kubernetes_mca_permissions.flsnp">
        </MadCap:snippetBlock>
    <h2><a name="pods-service-account"/>Service Account for the Event Broker Pods</h2>
    <p>The event broker pods run a health-check script which needs Kubernetes API access to tag the pods as active.</p>
    <p>To achieve this, the pods require a service account that's automatically created by the Helm chart with the following permissions:</p>
    <ul>
      <li>Access to <b>Patch</b> the <b>pods</b> resource</li>
    </ul>
    <p>The following Kubernetes YAML descriptor implements these permissions. In the example below, <code>&lt;target-namespace&gt;</code> is the name of the target namespace in your cluster. You can optionally specify the name of an existing role in your cluster to bind the service account to instead of <code>solace-broker-role</code>.</p>
    <pre class="Code" xml:space="preserve">apiVersion: v1
kind: ServiceAccount
metadata:
 name: solace-broker
 namespace: &lt;target-namespace&gt;
imagePullSecrets:
  - name: gcr-reg-secret
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: solace-broker-role
  namespace: &lt;target-namespace&gt;
rules:
- apiGroups: [""] # "" indicates the core API group
  resources: ["pods"]
  verbs: ["patch"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: solace-broker-role-binding
  namespace: &lt;target-namespace&gt;
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: solace-broker-role
subjects:
- kind: ServiceAccount
  name: solace-broker
  namespace: solace</pre>
  </body>
</html>
