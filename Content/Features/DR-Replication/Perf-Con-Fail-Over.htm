<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
  <head/>
  <body>
    <h1>Performing a Controlled Failover</h1>
    <p>To perform a controlled replication failover so that clients are switched over from a Message VPN with an active replication state at one site to the corresponding Message VPN at the alternate site, the following steps must be taken:</p>
    <ul>
      <li>
        <MadCap:xref href="#Switching_Replication_Service_Controlled_Fail_Verify">Step 1: Verify that the Replication Bridge is Bound to the Replication Queue</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#Switching_Replication_Service_Controlled_Fail_to_standby">Step 2: Switch the Message VPN Replication State to Standby</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#Switching_Replication_Service_Controlled_Fail_drain">Step 3: Wait for the Replication Queue in the Formerly Active Message VPN to Drain</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#Switching_Replication_Service_Controlled_Fail_heuristic_complete">Step 4: Heuristically Commit or Rollback Any In-Progress Transactions</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#Switching_Replication_Service_Controlled_Fail_make_active">Step 5: Make the Formerly Replication Standby Message VPN Replication Active</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#Switching_Replication_Service_Controlled_Fail_Delete">Step 6: Delete the Heuristically Completed Transactions</MadCap:xref>
      </li>
    </ul>
    <p class="Note">To be truly controlled, the replication bridge connection from the replication site that will take over activity must be bound to the other replication site’s replication queue. Before performing a controlled failover, every effort should be made to minimize the possibility of disconnecting the replication bridge. After the procedure has been started by configuring the Message VPNs in the site to give up activity with a replication standby state, if the replication bridge connection goes down before the replication queue has been drained, the failover becomes an uncontrolled failover.</p>
    <p>In the example scenario used in these steps, the clients from a single Message VPN (<code>Trading_VPN</code>) with an active replication state at one site (New York) are switched to the corresponding Message VPN with a standby replication state at the alternate site (Boston).</p>
    <p>While this simple example only shows replication sites with a single Message VPN, in real world scenarios, these steps must be performed through the CLI for each Message VPN involved in a replication site failover.</p>
    <h2 class="with-rule"><a name="Switching_Replication_Service_Controlled_Fail_Verify"/>Step 1: Verify that the Replication Bridge is Bound to the Replication Queue</h2>
    <p>Verify that the replication bridge from the event broker with the replication-standby Message VPN that you want to make active is bound to the replication queue of the  Message VPN with the active replication state.</p>
    <p>Here it is assumed that <code>NY_EventBroker1</code> and <code>BOS_EventBroker</code> are active for the Guaranteed Messaging-enabled virtual router at their respective sites.</p>
    <p style="font-weight: bold;">New York Data Center</p>
    <pre xml:space="preserve">NY_EventBroker1&gt; show message-vpn Trading_VPN replication
Flags Legend:
A - Admin State (U=Up, D=Down)
C - Config State (A=Active, S=Standby)
B - Local Bridge State (U=Up, Q=Queue Unbound, D=Down, -=N/A)
R - Remote Bridge State (U=Up, D=Down, -=N/A)
Q - Queue State (U=Up, D=Down, -=N/A)
S - Sync Replication Eligible (Y=Yes, N=No, -=N/A)
M - Reject Msg When Sync Ineligible (Y=Yes, N=No)
T - Transaction Replication Mode (A=Async, S=Sync, -=N/A)

Message VPN                      A C B R Q S M T
-------------------------------- - - - - - - - - -
Trading_VPN                      U A - U U - N A

NY_EventBroker1&gt; </pre>
    <p style="font-weight: bold;">Boston Data Center</p>
    <pre xml:space="preserve">BOS_EventBroker&gt; show message-vpn Trading_VPN replication
Flags Legend:
A - Admin State (U=Up, D=Down)
C - Config State (A=Active, S=Standby)
B - Local Bridge State (U=Up, Q=Queue Unbound, D=Down, -=N/A)
R - Remote Bridge State (U=Up, D=Down, -=N/A)
Q - Queue State (U=Up, D=Down, -=N/A)
S - Sync Replication Eligible (Y=Yes, N=No, -=N/A)
M - Reject Msg When Sync Ineligible (Y=Yes, N=No)
T - Transaction Replication Mode (A=Async, S=Sync, -=N/A)

Message VPN                      A C B R Q S M T
-------------------------------- - - - - - - - - -
Trading_VPN                      U S U - - - N A

BOS_EventBroker&gt; </pre>
    <h2 class="with-rule"><a name="Switching_Replication_Service_Controlled_Fail_to_standby"/>Step 2: Switch the Message VPN Replication State to Standby</h2>
    <p>Switch the currently replication-active Message VPN to standby.</p>
    <p style="font-weight: bold;">New York Data Center</p>
    <pre>NY_EventBroker1(configure)# message-vpn Trading_VPN
NY_EventBroker1(configure/message-vpn)# replication state standby</pre>
    <h2 class="with-rule"><a name="Switching_Replication_Service_Controlled_Fail_drain"/>Step 3: Wait for the Replication Queue in the Formerly Active Message VPN to Drain</h2>
    <p>Allow any messages or transactions that are in progress from the formerly replication-active Message VPN to its corresponding Message VPN on its replication mate to arrive . Allowing the propagation of all messages and transactions to the standby Message VPN can prevent the loss of asynchronous replication messages and transactions.</p>
    <p>To determine if the replication queue for the Message VPN that was just changed from active to standby has drained, enter the <b>show queue</b> command for the Message VPN’s replication queue (named <code>#MSGVPN_REPLICATION_DATA_QUEUE</code>). When the output displays a value of 0 for "Current Messages Spooled", the queue has been drained.</p>
    <p style="font-weight: bold;">New York Data Center</p>
    <pre xml:space="preserve">NY_EventBroker1(configure)# show queue #MSGVPN_REPLICATION_DATA_QUEUE message-vpn Trading_VPN 
Name                                 : #MSGVPN_REPLICATION_DATA_QUEUE
Message VPN                          : Trading_VPN
...
Current Messages Spooled             : 1
Current Spool Usage (MB)             : 0.0006
...</pre>
    <p>The system administrator should not configure the Message VPN in the other replication mate (<code>BOS_EventBroker</code>) as replication-active until "Current Messages Spooled" is 0 for the replication queue for the Message VPN that was just switched to replication standby.</p>
    <h2 class="with-rule"><a name="Switching_Replication_Service_Controlled_Fail_heuristic_complete"/>Step 4: Heuristically Commit or Roll Back Any In-Progress Transactions</h2>
    <p>If the Message VPN is using XA transactions, there may be some prepared transactions on the formerly active site that need to be heuristically committed or rolled back. Only prepared transactions have to be addressed. Transactions in other states can be ignored. If you do not deal with the prepared transactions:</p>
    <ul>
      <li>you will waste transaction resources that will reduce the transaction handling capacity of both sites</li>
      <li>in the event of a failback to the originally active site, duplicate message delivery or message loss may occur</li>
    </ul>
    <p>For information on how to heuristically commit or roll back transactions, refer to <MadCap:xref href="../../Messaging/Guaranteed-Msg/Performing-Heuristic-Actions.htm">Performing Heuristic Actions on Transactions</MadCap:xref>.</p>
    <p class="Note">It is important that you only perform the heuristic commit or heuristic rollback operations on the formerly active Message VPN.</p>
    <p>Deciding whether to commit or roll back the transaction will depend on various factors. When looking at XA transactions, the end goal is to make sure that the transactions are treated consistently on all branches of the distributed transaction across both replication sites. Here are some guidelines for making this decision:</p>
    <ul>
      <li>For prepared XA transactions that are controlled by a transaction manager in an application server, you should check the logs or state of the transaction manager for the XID of the prepared transaction to examine the other branches of the distributed transaction:<ul><li>If all the other branches have been committed, you should heuristically commit the transaction</li><li>If any of the other branches have rolled back, you should heuristically roll back the transaction</li></ul></li>
      <li>For XA prepared transactions that are not controlled by a transaction manager, manually coordinate the distributed transaction so that all the branches of the distributed transaction are either committed or rolled back.</li>
    </ul>
    <h3>Showing Replicated Transactions</h3>
    <p>To show replicated transactions, enter the following User EXEC command:</p>
    <pre>solace&gt; show transaction replicated</pre>
    <p><u>Example</u>:</p>
    <pre xml:space="preserve" class="Code">Solace # show transaction message-vpn blue_02 state PREPARED replicated 
Flags Legend
T - Transaction Type (X=XA L=Local)
S - Transaction State (A=Active S=Suspended I=Idle P=Prepared C=Complete)
R - Replicated (Y=Yes N=No)
XID                                                                   Messages
Message VPN                                   T S R Last State Change  Spooled
--------------------------------------------- - - - ----------------- --------
0021ABC4-00-01
blue_02                                       X P Y                1s        0</pre>
    <p>To show the details of in-progress replicated transactions, enter the following User EXEC command:</p>
    <pre>solace&gt; show transaction message-vpn blue_02 state PREPARED replicated detail</pre>
    <p><u>Example</u>:</p>
    <pre xml:space="preserve" class="Code">Solace # show transaction replicated detail
XID:                       0021B028-00-01
Message VPN:               blue_02
Client:                    username/15848/#000c0001
Client Username:           default
Session:                   N/A
Idle Timeout:              0
Type:                      XA
State:                     PREPARED
Replicated:                Yes
Last State Change:         0d 0h 0m 0s
Messages:                  10
Messages Published:        0
Messages Consumed:         150
Publisher Messages:
Message Id           Topic
-------------------- -----------------------------------------------------------
Consumer Messages:
Message Id           Type  Endpoint Name
-------------------- ----- -----------------------------------------------------
3118727406           queue test
3118727407           queue test
3118727408           queue test
3118727409           queue test
3118727410           queue test
3118727411           queue test
3118727412           queue test
3118727413           queue test
3118727414           queue test
3118727415           queue test</pre>
    <p>To show the details of  a particular transaction, enter the following User EXEC command:</p>
    <pre>solace&gt; show transaction xid &lt;xid&gt; detail</pre>
    <p><u>Where</u>:</p>
    <p><code>xids</code> specifies the XID of the transaction to be displayed.</p>
    <h2 class="with-rule"><a name="Switching_Replication_Service_Controlled_Fail_make_active"/>Step 5: Make the Formerly Replication Standby Message VPN Replication Active</h2>
    <p>To restore the server, you need to switch the formerly replication-standby message VPN to the active state.</p>
    <pre>BOS_EventBroker(configure)# message-vpn Trading_VPN
BOS_EventBroker(configure/message-vpn)# replication state active</pre>
    <p>At this point, client should be able to re-connect to the message VPN and full replication service will resume.</p>
    <h2 class="with-rule"><a name="Switching_Replication_Service_Controlled_Fail_Delete"/>Step 6: Delete the Heuristically Completed Transactions</h2>
    <p>If there are transactions that you previously heuristically completed, you should delete them to free up resources. You must always delete the completed transactions on the formerly active site. You may have to delete completed transactions on the newly active site, depending on the replication mode and the XA transaction manager. The XA transaction manager may automatically delete the heuristically completed transactions on the active Message VPN after it connects to the newly active site as it reconciles the XA transaction states. You should allow this process to complete before deleting the completed transactions.</p>
    <p>To delete a completed transaction, enter the following ADMIN command on the formerly active site:</p>
    <pre>solace(admin/message-spool) delete-transaction xid &lt;xid&gt;</pre>
    <p><u>Where</u>:</p>
    <p><code>xid</code> specifies the XID of the transaction to be deleted.</p>
    <p>You should check both the standby and active Message VPNs for completed transactions. </p>
  </body>
</html>
