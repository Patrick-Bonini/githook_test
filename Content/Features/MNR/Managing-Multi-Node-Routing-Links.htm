<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
  <head/>
  <body>
    <h1>Multi-Node Routing</h1>
    <p>Multi-Node Routing (MNR) allows multiple Solace PubSub+ event brokers to be networked together so that Direct messages published from clients connected to one event broker can be delivered to clients connected to other event brokers. This effectively distributes message routing loads across multiple event brokers in a network resulting in aggregate message forwarding rates across the network that exceed the capacity of any one event broker.</p>
    <p>Solace's Content Shortest Path First (CSPF) protocol is used to link neighboring event brokers and allow them to discover the complete messaging network topology to which they belong. Event brokers can then determine which neighbor is the optimal node for forwarding messages addressed to specific destination event brokers. Topology discovery is continuous and dynamically updated as event brokers within the network go on or off line.</p>
    <p>The Subscription Management Routing Protocol (SMRP) is also used to enable linked neighboring event brokers to propagate topic subscriptions added by the clients of one event broker throughout the messaging network. This allows messages that are published to one event broker to be routed to other event brokers that also have connected clients interested in those topics.</p>
    <p>By default, data and routing traffic carried over MNR links is carried in plain text over TCP. Data compression can be applied on these links; however, if you'll be transmitting sensitive data in the messages sent between event brokers, Transport Layer Security (TLS)/ Secure Sockets Layer (SSL) encryption can be applied to the MNR links' data channels.</p>
    <h3><a name="Linking"/>Linking Event Brokers</h3>
    <p>A routing link defines the route for connectivity between event brokers. When building a messaging network, administrators must explicitly configure the routing links between event broker neighbors. Both ends of a message routing link must be configured. That is, to link event brokers A and B, there must be a neighbor configuration in A for B, and a neighbor configuration in B for A. Using these bi-directional links, those neighbors are then able to exchange network topology using the CSPF protocol and subscription information using SMRP. These configured neighbor links allow Direct messages published by clients to travel between neighbors on their way to the final subscriber clients.</p>
    <p>Compression can be optionally used on neighbor event broker data connections (only data connections are affected).</p>
    <p>Multiple bi-directional routing links can be used to route messages between event brokers in your network for load balancing or redundancy, and the routing protocols that are used will calculate the shortest path (as defined by link costs). Routes with lower link costs are preferred over those with higher link costs. If there are multiple routing links with equal cost paths, then a route with less hops will be chosen as the preferred route.</p>
    <p>Where alternative routes are possible, an administrator can assign explicit link costs to indicate the best inter-neighbor message route. The rationale for assigning a higher link cost to a particular route could be based on considerations such as the speed, latency, or monetary cost of the underlying communication link.</p>
    <h4>Routing Link Cost Examples</h4>
    <p>To prefer one route over another (for example, to specify a default link), you can change the routing link costs to set the preferred message route.</p>
    <p>In the example shown in <MadCap:xref href="#multi-node-routing-link-cost-ex-1">Routing Link Cost—Example 1</MadCap:xref>, there are four bi-directional routing links available between event brokers A, B, C, and D:</p>
    <ul>
      <li>A-B routing link</li>
      <li>B-C routing link</li>
      <li>B-D routing link</li>
      <li>C-D routing link</li>
    </ul>
    <p>If the cost associated with the A-B routing link is set to 150, and the cost associated with the three other routing links is set to 100, messages routed from event broker A to C travel from event broker A to event broker B and then on to event broker C.</p>
    <p class="GraphicCaption"><a name="multi-node-routing-link-cost-ex-1"/>Routing Link Cost—Example 1<br/><img src="../../Resources/Images/MNR/Fig 6-1_Cost_Link.jpg" alt="Routing Link Cost-Example 1"/></p>
    <p>However, as shown in <MadCap:xref href="#multi-node-routing-link-cost-ex-2">Routing Link Cost Example 2</MadCap:xref>, if the cost associated with the A-B routing link is set to 150, while the cost associated with the B-C routing link is set to 250, and the cost associated with the C-D and B-D routing links is set to 100, messages routed from event broker A to C travel from event broker A to Site B, on to event broker D, and then to event broker C. Such a cost configuration may be desirable in cases where, for example, two event broker sites in one city are connected by a high-speed link, while other overseas event broker sites are connected by low-speed links.</p>
    <p class="GraphicCaption"><a name="multi-node-routing-link-cost-ex-2"/>Routing Link Cost Example 2 <br/><img src="../../Resources/Images/MNR/Fig 6-2_Cost_Link.jpg" alt="Routing Link Cost—Example 2"/></p>
    <h3><a name="Subscrip2"/>Subscription Propagation and Management</h3>
    <p>When MNR is used, topic subscriptions and matching messages are only distributed between matching Message VPNs. This means that an event broker with a topic subscription in one message VPN can only receive matching messages from a neighbor event broker that were published to a Message VPN of the same name. For example if a message was published to Message VPN <code>Blue</code> on <code>Router A</code>, that message may be delivered to a client on <code>Router B</code> with a matching topic subscription in a Message VPN <code>Blue</code>, but it may not be delivered to a client on <code>Router B</code> with a matching topic subscription in a Message VPN <code>Green</code>.</p>
    <p>Topic subscriptions can be added by external clients and internal clients (for example, the internal client of the Message VPN, <code>#client</code>). When external client subscriptions are associated with a specific virtual router name; internal client subscriptions are associated with a physical event broker name.</p>
    <h4><a name="Exporting-Subscriptions"/>Exporting Topic Subscriptions</h4>
    <p>Each Message VPN has a topic subscription export policy associated with it, which controls whether or not topic subscriptions on the Message VPN get advertised to other event brokers in the network. The default policy is  not to export subscriptions.</p>
    <p>To receive messages from other event brokers, the subscription export policy in a Message VPN must be set to export subscriptions. This causes all subscriptions added locally to the Message VPN to be dynamically propagated to the other event brokers in the network. </p>
    <p>For information on how to configure the subscription export policy, see <MadCap:xref href="../VPN/Configuring-VPNs.htm#Enable-Sub-Export">Enabling Subscription Export</MadCap:xref>.</p>
    <h2 class="with-rule"><a name="Prerequi"/>Configuration Prerequisites</h2>
    <p>Before configuring the MNR settings for each event broker used throughout the network, you'll need to read and observe all of the following:</p>
    <ol>
      <li>MNR uses  the static IP addresses of all event brokers in the message routing network. Before you can configure MNR on an event broker, you must know the static IP address of each neighbor you want the event broker to connect to.</li>
      <li>The event broker with the   name that comes first in alphabetical order initiates the TCP connections. </li>
      <li>You must ensure that the following TCP ports are opened on each event broker used in the message-routing network:<ol style="list-style-type: lower-alpha;"><li>The routing control port. The default is 55556.</li><li>One of either the SMF data, SMF compressed data, or SMF TLS / SSL data port, depending on the chosen configuration. The defaults are 55555, 55003, and 55443 respectively. </li></ol></li>
      <li>The event brokers must have unique physical router names.</li>
    </ol>
    <h2 class="with-rule"><a name="MNR"/>MNR Mode Configuration</h2>
    <p>In PubSub+ software event broker versions 8.13.0+, and appliance versions 9.1.0+, DMR routing mode is enabled by default. You must  enable MNR mode before you can use  MNR capabilities.</p>
    <p>To enable or disable MNR mode, do the following:</p>
    <p>To enable MNR mode, enter the following commands.</p>
    <pre xml:space="preserve">solace(configure)# routing
solace(configure/routing)# mode multi-node-routing [defer]</pre>
    <p>To disable MNR mode and enable DMR mode, enter the following commands:</p>
    <pre xml:space="preserve">solace(configure)# routing
solace(configure/routing)# mode dynamic-message-routing [defer]</pre>
    <p><u>Where</u>:</p>
    <p><code>defer</code> specifies to defer the change until the next event broker restart.</p>
    <p>You must restart the event broker before changes take effect. If you do not specify the <code>defer</code> keyword, you are immediately prompted to restart the event broker.</p>
    <h2 class="with-rule"><a name="Create-Neighbor-Links"/>Creating Neighbor Links</h2>
    <p>A CSPF routing link goes from one event broker to a neighboring event broker, as identified by its physical router name.</p>
    <p class="Note">To successfully link neighboring event brokers, both ends of a message routing link must be configured. That is, between two Solace event brokers A and B, there must be a neighbor configuration in A for B, and a neighbor configuration in B for A.</p>
    <p>To create a CSPF routing link from the given event broker to a neighbor event broker, enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# multi-node-routing
solace(configure/routing/multi-node-routing)# create cspf neighbor &lt;physical-router-name&gt;</pre>
    <p>To edit the properties of an existing CSPF routing link  from the given event broker to a neighbor event broker, enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# multi-node-routing
solace(configure/routing/multi-node-routing)# cspf neighbor &lt;physical-router-name&gt;</pre>
    <p>To enable a CSPF routing link, enter the following command:</p>
    <pre xml:space="preserve">solace(...ting/multi-node-routing/cspf/neighbor)# no shutdown</pre>
    <p><u>Where</u>:</p>
    <p><code>&lt;physical-router-name&gt;</code> is the name of the event broker. This name can contain up to 64 characters, composed of alphanumeric characters 0 to 9, a to z, A to Z, underscore '_', dot '.', and hyphen. Note that '_', '.' and '-' cannot be used at the beginning or end of an event broker name. Router names must be unique among all configured event brokers.</p>
    <p>The no version of this command, <code>no cspf neighbor</code>, deletes the CSPF link on the given event broker, as long as the neighbor is shutdown.</p>
    <p> The configuration parameters used for the link are set separately from the command that creates the routing link. The configuration tasks that you can perform for an existing link include:</p>
    <ul>
      <li>
        <MadCap:xref href="#Conf-Neigh-IPs">Configuring Neighborsʼ IPs and Data Ports</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#Config-Neigh-Ctrl-Ports">Configuring Neighborsʼ Control Ports</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#Config-Compression">Configuring Compressed Data Connections</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#Config-SSL-Connections">Enabling TLS/SSL Data Encryption</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#Config-Link-Costs">Configuring Link Costs</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#Neighbor-TCP">Configuring TCP Settings</MadCap:xref>
      </li>
    </ul>
    <h3><a name="Conf-Neigh-IPs"/>Configuring Neighbors' IPs and Data Ports</h3>
    <p>To configure the IP address and optional port that the neighbor's data port is reachable from, enter the following commands:</p>
    <pre class="Code">solace(configure)# routing
solace(configure/routing)# multi-node-routing
solace(configure/routing/multi-node-routing)# cspf neighbor &lt;physical-router-name&gt;
solace(...ting/multi-node-routing/cspf/neighbor)# connect-via &lt;ip-port&gt;</pre>
    <p><u>Where</u>:</p>
    <p><code>&lt;ip-port&gt;</code> is the static IP address or fully qualified domain name (FQDN) and TCP port of the neighbor event broker in the form <code>IP address[:port]</code> or <code>FQDN[:port]</code>. <MadCap:snippetText src="../../Resources/Snippets/ip-address-format.flsnp"/> If the port is unspecified, the default is 55555. The FQDN can contain up to 253 characters.</p>
    <h3><a name="Config-Neigh-Ctrl-Ports"/>Configuring Neighbors' Control Ports</h3>
    <p>To configure the IP address and optional port that the neighborʼs data port is reachable from, enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# multi-node-routing
solace(configure/routing/multi-node-routing)# cspf neighbor &lt;physical-router-name&gt;
solace(...ting/multi-node-routing/cspf/neighbor)# control-port &lt;control-port&gt;</pre>
    <p><u>Where</u>:</p>
    <p><code>&lt;control-port&gt;</code> is the TCP control port number of the neighbor event broker. If left unspecified, the control port used is the one returned by the neighbor event broker during the neighbor link establishment phase. If specified as a decimal value from 0 to 65535, then this value takes precedence over that returned by the neighbor event broker.</p>
    <h3><a name="Config-Compression"/>Configuring Compressed Data Connections</h3>
    <p>You can use compression on the data connections to the neighbor event broker. Only data connections are affected—control connections are always uncompressed.</p>
    <p>Compression is only available on plain-text connections to the neighbor event broker (the default). Message compression is not available on TLS/ SSL encryption is used for the data connections (that is, secure/encrypted client connections) to the neighbor.</p>
    <p>To use compressed data connections to the neighbor, enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# multi-node-routing
solace(configure/routing/multi-node-routing)# cspf neighbor &lt;physical-router-name&gt;
solace(...ting/multi-node-routing/cspf/neighbor)# compressed-data</pre>
    <p>The no version of this command, <code>no compressed-data</code>, resets data connections to the default of uncompressed connections.</p>
    <p class="Note">This attribute can only be changed when the neighbor event broker is shutdown.
        </p>
    <h3><a name="Config-SSL-Connections"/>Enabling TLS/SSL Data Encryption</h3>
    <p>You can use TLS/ SSL encryption  on the data connections to the neighbor event broker. Only data connections are affected. Control connections are not encrypted.</p>
    <p>To use TLS/SSL data encryption on neighbor links, enable TLS/SSL encryption for each given link through the command below:</p>
    <p><a name="Enable-TLS"/>To enable the use encrypted data connections to the neighbor, enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# multi-node-routing
solace(configure/routing/multi-node-routing)# cspf neighbor &lt;physical-router-name&gt;
solace(...ting/multi-node-routing/cspf/neighbor)# ssl-data</pre>
    <p>The no version of this command, <code>no ssl-data</code>, resets data connections to the default of plain-text connections.</p>
    <div class="Note">
      <ul>
        <li>This attribute can only be changed when the neighbor event broker is shutdown.</li>
        <li>TLS/SSL encryption is not available when data compression is used  because data compression requires plain-text connections.</li>
        <li>TLS/SSL encryption is only supported on the data links between  appliances and the data links between software event brokers of release 8.5.0 and greater.</li>
      </ul>
    </div>
    <h4><a name="Config-Ciphers"/>Configuring Cipher Suites</h4>
    <p>A list of cipher suites, in order of preference, can be specified to negotiate with the remote event broker. By default, all supported cipher suites are used, ordered from the most secure to the least secure. An empty cipher suite list will prevent the routing link from initiating a connection.</p>
    <p>For a full list of cipher suites supported by  event brokers, see <MadCap:xref MadCap:unresolvedLink="import-link:transport_security_and_compression_445161506_28596" href="../../Security/TLS-SSL-Message-Encryption-Overview.htm#transport_security_and_compression_440573439_213360">Supported Cipher Suites</MadCap:xref>.</p>
    <p>To configure which cipher suites should be use on the routing link, enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# multi-node-routing
solace(configure/routing/multi-node-routing)# cspf neighbor &lt;physical-router-name&gt;
solace(...ting/multi-node-routing/cspf/neighbor)# ssl
solace(.../multi-node-routing/cspf/neighbor/ssl)# cipher-suite {default | empty | name &lt;suite-name&gt; [{before | after} &lt;suite-name&gt;]}</pre>
    <p><u>Where</u>:</p>
    <p><code>default</code> specifies to use the default list of supported cipher suites, ordered from most secure to least secure.</p>
    <p><code>empty</code> removes all cipher suites from the list.</p>
    <p><code>name &lt;suite-name&gt;</code> adds the specified cipher suite to the list of suites to be used.</p>
    <p><code>before &lt;suite-name&gt;</code> specifies that the suite specified by the <code>name</code> parameter should be inserted into the list immediately before (that is, with a higher priority than) the suite specified by the <code>before</code> parameter.</p>
    <p><code>after &lt;suite-name&gt;</code> specifies that the suite specified by the <code>name</code> parameter should be inserted into the list immediately after (that is, with a lower priority than) the suite specified by the <code>after</code> parameter.</p>
    <p>The no version of this command, <code>no cipher suite name &lt;suite-name&gt;</code>, removes the specified cipher suite from the list of eligible cipher suites.</p>
    <h4><a name="Config-Trusted-CNs"/>Configuring Trusted Common Names</h4>
    <p>The routing link uses a list of trusted common names to verify the name in the certificate presented by the neighbor. By default, the list of trusted common names is empty, meaning that the link will not trust any common names.</p>
    <p> To ensure that link will be established, regardless of whether the event broker is initiating or accepting the neighbor connection, this list should contain both the server-certificate CN and client-certificate CN of the neighbor event broker.</p>
    <p>To configure a list of trusted common names for the link, enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# multi-node-routing
solace(configure/routing/multi-node-routing)# cspf neighbor &lt;physical-router-name&gt;
solace(...ting/multi-node-routing/cspf/neighbor)# ssl
solace(.../multi-node-routing/cspf/neighbor/ssl)# trusted-common-name {empty | name &lt;common-name&gt;}</pre>
    <p><u>Where</u>:</p>
    <p><code>empty</code> removes all previously specified common names from the list.</p>
    <p><code>name &lt;common-name&gt;</code> specifies the name of a certificate to add to the list of trusted common names.</p>
    <p>The no version of this command, <code>no trusted-common-name name &lt;common-name&gt;</code>, removes the specified common name from the list.</p>
    <p class="Note">The trusted common names list can be left empty if the <MadCap:xref href="#Trusted-CNs">Enforce Trusted Common Names</MadCap:xref> certificate validation option is disabled.
        </p>
    <h3><a name="Config-Link-Costs"/>Configuring Link Costs</h3>
    <p>If there are multiple routes between neighbors, and you want to enforce one route over another, you can assign specific costs to routing links to reflect the differences in the speed or monetary cost of each underlying communication link. Links with lower costs are preferred over links with higher costs. For examples of how to calculate link costs, see .</p>
    <p>To change the cost for a routing link to a neighbor event broker, enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# multi-node-routing
solace(configure/routing/multi-node-routing)# cspf neighbor &lt;physical-router-name&gt;
solace(...ting/multi-node-routing/cspf/neighbor)# link-cost &lt;cost&gt;</pre>
    <p><u>Where</u>:</p>
    <p><code>&lt;cost&gt;</code> is the integer value representing the new link cost to the neighbor event broker. The valid range is 1 to 255. If this parameter is not provided, the default value is 100.</p>
    <p>The no version of this command, <code>no link-cost</code>, resets the link-cost value to the default.</p>
    <p class="Note">Existing link costs can be viewed using the <code>show cspf route</code> User EXEC command.
        </p>
    <h3><a name="Neighbor-TCP"/>Configuring TCP Settings</h3>
    <p>For information on how to configure the TCP settings for neighbor links, see <MadCap:xref href="../../Services/Configuring-TCP-Settings.htm">Configuring TCP Settings</MadCap:xref>. This section discusses configuring the TCP settings used for event broker-to-event broker connections, as well as client‑to‑event broker connections.</p>
    <h2 class="with-rule"><a name="Assign-Routing-Int"/>Assigning Routing Interfaces</h2>
    <p>A routing interface must be assigned to use Solace routing protocols such as the CSPF and SMRP protocols that are used for MNR. </p>
    <p class="Note">In versions prior to 9.5.0, a routing interface must also be assigned if the event broker is to be used in an HA redundant pair or if Config-Sync is to be enabled.</p>
    <p>To assign a routing interface, enter the following command:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# interface &lt;phy-interface&gt;</pre>
    <p><u>Where</u>:</p>
    <p><code>&lt;phy-interface&gt;</code> is an ASCII string specifying the Ethernet interface port or LAG to be assigned. Valid values are eth&lt;port&gt; (for example, <code>eth1</code>); &lt;cartridge&gt;/&lt;slot&gt;/&lt;port&gt; (for example, <code>1/1/8</code>); &lt;cartridge&gt;/&lt;slot&gt;/lag&lt;N&gt; (for example, <code>1/1/lag1</code>). There is no default value.</p>
    <h2 class="with-rule"><a name="Start-Stop-Routing"/>Starting/Stopping Routing Protocols</h2>
    <p>To start running Solace routing protocols on the event broker (such as the CSPF protocol and SMRP used for MNR), enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# no shutdown</pre>
    <p>To stop Solace routing protocols from running on the event broker, enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# shutdown</pre>
    <div class="Note">
      <ul>
        <li>By default, Solace routing protocols are stopped (that is, they are not running on event brokers).</li>
        <li>To start MNR, you must start each event broker being networked together.</li>
        <li>Whenever an event broker is restarted while running MNR, SMRP needs to learn of the topic subscriptions it is to become active for. It does this by synchronizing its database with the neighbor event brokers. However, if Solace routing protocols are stopped on any neighbor event broker, the event broker that is attempting to synchronize its SMRP database will stop its resynchronization attempt after three minutes.</li>
      </ul>
    </div>
    <h2 class="with-rule"><a name="managing_multi-node_routing_links_975483870_201576"/>Neighbor Link Configuration Example</h2>
    <p>An MNR network consists of two or more event brokers, with CPSF neighbor link connections provisioned between neighboring event brokers in accordance with the defined network topology.</p>
    <p>Determining which pairs of event brokers have neighbor link connections determines the topology of a network. In this example we only describe the tasks required to configure event brokers for an MNR link configuration once all the network engineering has been done. As well, this section applies to appliances and assumes that the basic event broker configuration tasks described in <MadCap:xref href="../../Admin/IP-Interfaces/Managing-Appliance-IP-Interfaces.htm">Managing Appliance Interfaces</MadCap:xref> have been completed.</p>
    <p>To successfully provision an MNR network, two separate levels of configuration are required, in this order:</p>
    <ol>
      <li>
        <MadCap:xref href="#managing_multi-node_routing_links_975483870_201586">Router-Wide Configuration Tasks</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#managing_multi-node_routing_links_975483870_201650">Per-Neighbor Link Configuration Tasks</MadCap:xref>
      </li>
    </ol>
    <h3><a name="managing_multi-node_routing_links_975483870_201586"/>Event Broker-Wide Configuration Tasks</h3>
    <p>Perform these tasks on each and every event broker in the network, regardless of the number of neighbor link connections, to provision and enable the routing interface used by the Solace routing protocols for MNR:</p>
    <ol>
      <li>To enable event brokers to connect to the routing interface of their neighbors, configure a static IP interface on each event broker in the MNR network. This static IP interface can either be an independent port on the NAB, or a LAG interface consisting of one or more NAB ports.
            <p>Create the static IP interface:</p><pre>solace&gt; enable
solace# configure
solace(configure)# ip vrf msg-backbone
solace(configure/ip/vrf)# create interface 1/6/1:3 static</pre><p>Set the static IP interface address:</p><pre>solace(configure/ip/vrf/interface)# ip-address 192.168.1.10/24</pre><p>Enable the static IP interface:</p><pre xml:space="preserve">solace(configure/ip/vrf/interface)# no shutdown
solace(configure/ip/vrfinterface)# exit</pre><p>Configure the IP route for the Message Backbone VRF:</p><pre xml:space="preserve">solace(configure/ip/vrf)# route default 192.168.1.1
solace(configure/ip/vrf)# end
solace#</pre><p class="Note">To assign independent IP addresses to all ports of the NAB (that is, when there is no LAG configured), or have a mixture of some NAB Ethernet ports grouped into a single LAG and the remaining ports independently addressed, see <MadCap:xref href="../../Admin/IP-Interfaces/Managing-Appliance-IP-Interfaces.htm">Managing Appliance Interfaces</MadCap:xref>.</p></li>
      <li>Verify IP connectivity between the static IP addresses of neighboring event brokers.
            <p>In the following example, the static IP interface address of the neighbor event broker is <code>192.168.1.11</code>:</p><pre>solace(configure)# ping msg-backbone:192.168.1.11</pre><pre>PING 192.168.1.11 56(84) bytes of data.
64 bytes from 192.168.1.11: icmp_seq=1 ttl=20 time=0.105ms
64 bytes from 192.168.1.11: icmp_seq=2 ttl=20 time=1.570ms
64 bytes from 192.168.1.11: icmp_seq=3 ttl=20 time=0.098ms
64 bytes from 192.168.1.11: icmp_seq=4 ttl=20 time=0.089ms

--- 192.168.1.11 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 4000ms
rtt min/avg/max/mdev = 0.089/0.466/1.570/0.736 ms</pre></li>
      <li>On each event broker, configure a routing interface and enable the Solace routing protocols. 
            <p class="Note">The routing interface should be the same physical interface as the static IP interface already created in step 1, whether it be a single port on the NAB or a LAG interface. </p><pre>solace# configure
solace(configure)# routing
solace(configure/routing)# interface 1/6/1
solace(configure/routing)# no shutdown</pre></li>
    </ol>
    <h3><a name="managing_multi-node_routing_links_975483870_201650"/>Per-Neighbor Link Configuration Tasks</h3>
    <p>After successfully completing the preceding event broker-wide configuration tasks, do the following:</p>
    <ol>
      <li>Configure the CSPF neighbor link connections between neighbor event brokers.
            <p>For example, assuming the neighboring event brokers are named <code>solace10</code> and <code>solace11</code>, and they have static IP addresses of 192.168.1.10 and 192.168.1.11, respectively:</p><pre>solace10(configure)# routing
solace10(configure/routing)# multi-node-routing
solace10(configure/routing/multi-node-routing)# create cspf neighbor solace11
solace10(...ting/multi-node-routing/cspf/neighbor)# connect-via 192.168.1.11</pre><pre>solace11(configure)# routing
solace11(configure/routing)# multi-node-routing
solace11(configure/routing/multi-node-routing)# create cspf neighbor solace10
solace11(...ting/multi-node-routing/cspf/neighbor)# connect-via 192.168.1.10</pre></li>
      <li>Repeat the previous step for both sides of each and every CSPF neighbor link connection in the MNR network.</li>
    </ol>
    <h2 class="with-rule"><a name="managing_multi-node_routing_links_975483870_215498"/>Configuring Neighbor Queues</h2>
    <p>CSPF neighbor queues are used to enqueue messages before they are sent over the data connection to neighbor event brokers. These TCP transmit queues are used to manage the flow of data that is transmitted from the event broker over the routing links to its neighbors.</p>
    <p>You can perform the following tasks for these queues:</p>
    <ul>
      <li>
        <MadCap:xref href="#managing_multi-node_routing_links_975483870_215509">Configuring Max Neighbor Queue Depths</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#managing_multi-node_routing_links_975483870_215518">Configuring Minimum Message Bursts</MadCap:xref>
      </li>
    </ul>
    <div class="Caution">
      <p class="Tbl_Body">Always contact Solace for technical support before you attempt to configure the CSPF neighbor queues on event brokers. Failure to do so may result in data loss or service interruption due to unwanted secondary effects on event broker performance.</p>
    </div>
    <h3><a name="managing_multi-node_routing_links_975483870_215509"/>Configuring Max Neighbor Queue Depths</h3>
    <p>Each neighbor queue has an associated maximum depth that is measured in work units, whereby a work unit represents 2048 bytes of a message. When a new message is placed on the neighbor queue, its depth in work units is checked against the configured maximum depth of the queue.</p>
    <p>If the CSPF neighbor queue depth is at or above the configured maximum depth and new messages are received, the oldest messages currently queued can be discarded to make room for the newest received messages. When this happens a dataplane statistic for <code>Egress Congestion Discards</code> is incremented.</p>
    <p>To modify the maximum depth of CSPF neighbor queues, enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# multi-node-routing
solace(configure/routing/multi-node-routing)# cspf queue
solace(...routing/multi-node-routing/cspf/queue)# max-depth &lt;depth&gt;</pre>
    <p><u>Where</u>:</p>
    <p><code>&lt;depth&gt;</code> is the integer value representing the number of work units for the neighbor queues. The valid range is 50 to 262144. The default value is 20000. Changing this value does not affect messages already successfully placed on the queue.</p>
    <p>The no version of this command, <code>no max-depth</code>, resets the neighbor to the associated default.</p>
    <p class="Note">The formula to convert a message size to number of work units is: <code>NumWorkUnits = CEILING(message.length/2048)</code></p>
    <h3><a name="managing_multi-node_routing_links_975483870_215518"/>Configuring Minimum Message Bursts</h3>
    <p>A neighbor queue may temporarily exceed its maximum depth if it has a sufficiently sized minimum burst length tolerance. The minimum burst length tolerance ensures that a neighbor queue does not lose messages when it receives bursts of very large messages. It specifies the number of messages per queue that are always allowed entry into the queue, regardless of its current configured maximum depth.</p>
    <p>To configure the minimum number of messages that must be on a CSPF neighbor queue before the queue's depth is checked against the maximum depth setting (thereby allowing the queue to absorb a burst of large messages that exceeds the number of allowed work units), enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# multi-node-routing
solace(configure/routing/multi-node-routing)# cspf queue
solace(...routing/multi-node-routing/cspf/queue)# min-msg-burst &lt;depth&gt;</pre>
    <p><u>Where</u>:</p>
    <p><code>&lt;depth&gt;</code> is the integer value representing the queue burst depth in messages. The valid range is 0 to 262144. The default value is 255. Changing this value does not affect messages already successfully placed on the queue.</p>
    <p>The no version of this command, <code>no min-msg-burst</code>, resets the queue burst depth in messages to the default of 255.</p>
    <h3><a name="managing_multi-node_routing_links_975483870_215526"/>Showing CSPF Queue Settings</h3>
    <p>To view the CSPF queue settings on the event broker, enter the following command:</p>
    <pre>solace&gt; show cspf queue</pre>
    <h2 class="with-rule"><a name="Config-Encrypt"/>Configuring Neighbor Link Encryption</h2>
    <p>To use TLS/SSL encryption on the data connections between neighboring event brokers, the following configurations are required  on both event brokers on the routing link:</p>
    <ul>
      <li>TLS/SSL service must be configured and enabled for the event broker, which requires the TLS/SSL server certificate to be configured on the local event broker. See <MadCap:xref href="../../Security/Managing-Server-Certs.htm">Managing Server Certificates</MadCap:xref>.</li>
      <li>The client certificate file that identifies the local event broker must be loaded on the event broker. See <MadCap:xref href="#Config-Cert-to-Neigh">Configuring Certificate Files to Present to Neighbors</MadCap:xref>.</li>
      <li>Ensure that your certificate validation settings are set appropriately based on your network environment. Note that by default, the <code>enforce-trusted-common-name</code> setting is enabled. See <MadCap:xref href="#Config-Cert-Valid-Settings">Configuring Certificate Validation Settings</MadCap:xref>.</li>
      <li MadCap:conditions="Default.HideFromAllOutput">Ensure that the trusted roots for the remote server certificate and the remote client certificate are configured. See <MadCap:xref href="../../Security/Configuring-Client-Authentication.htm#Configur">Configuring Trusted Root Certificates</MadCap:xref>.</li>
      <li>TLS/SSL encryption must be enabled and configured for the neighbor link. See <MadCap:xref href="#Config-SSL-Connections">Enabling TLS/SSL Data Encryption</MadCap:xref>.</li>
    </ul>
    <h3><a name="Config-Cert-to-Neigh"/>Configuring Certificate Files to Present to Neighbors</h3>
    <p>To use TLS/SSL data connections to neighboring event brokers, you must configure the client certificate that neighbor links will present to the remote event broker when initiating the data connections with the neighbor. The specified file must have already been added into the <code>/usr/sw/jail/certs</code> directory through the <b style="letter-spacing: 0em;">copy</b> Privileged EXEC command (see <MadCap:xref href="../../Admin/Managing-Event-Broker-Files.htm#Manage_Router_Files_Copy">Copying Files</MadCap:xref>).</p>
    <p>To configure the certificate file to use, enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# multi-node-routing
solace(configure/routing/multi-node-routing)# cspf
solace(...igure/routing/multi-node-routing/cspf)# ssl
solace(...e/routing/multi-node-routing/cspf/ssl)# client-certificate
solace(...e-routing/cspf/ssl/client-certificate)# certificate-file &lt;filename&gt;</pre>
    <p><u>Where</u>:</p>
    <p><code>&lt;filename&gt;</code> is the file name of the certificate to load. The certificate must be encoded with a Privacy Enhanced Mail (PEM) format. The maximum number of CA certificates that may be loaded is 64. Once a certificate is configured, a copy of it is saved internally. The file in the <code>certs</code> directory is no longer required.</p>
    <p>The no version of this command, <code>client-certificate</code>, deprovisions the specified client certificate.</p>
    <h3><a name="Config-Cert-Valid-Settings"/>Configuring Certificate Validation Settings</h3>
    <p>You can configure the certificate validation settings on an event broker that can accept TLS/SSL data connections from the neighbor event broker.  These settings are used for validating the client certificate that is passed from a neighbor event broker to the local event broker during a TLS/SSL handshake.</p>
    <p>The configuration parameters that you can adjust include the following:</p>
    <ul>
      <li>
        <MadCap:xref href="#Server-Name">Validate Server Name</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#Max-Chain">Maximum Certificate Chain Depth</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#Cert-Dates">Validate Certificate Dates</MadCap:xref>
      </li>
    </ul>
    <h4><a name="Server-Name"/>Validate Server Name</h4>
    <p>You can enable or disable the TLS authentication mechanism to verify the name used to connect to the neighbor. If enabled, the Server Name Indication (SNI) extension is sent on outgoing TLS connections and the server name used for that connection is verified against the server names in the Subject Alternative Name (SAN) extension in the certificate returned from the neighbor.</p>
    <p>This parameter is disabled for existing VPNs on brokers that have been upgraded from versions prior to 9.9; otherwise it is enabled by default.</p>
    <p>To enable validation of server names for MNR links, enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# multi-node-routing
solace(configure/routing/multi-node-routing)# cspf
solace(...igure/routing/multi-node-routing/cspf)# ssl
solace(...e/routing/multi-node-routing/cspf/ssl)# certificate-validation
solace(...uting/cspf/ssl/certificate-validation)# validate-server-name</pre>
    <p>The no version of this command, <code>no validate-server-name</code>, disables validation of the server names.</p>
    <h4><a name="Max-Chain"/>Maximum Certificate Chain Depth</h4>
    <p>The depth of a certificate chain is the number of signing CA certificates that are present in the chain back to a trusted self-signed root CA certificate. Setting a maximum certificate chain depth means that the event broker will reject any certificates whose depth is higher than the maximum limit.</p>
    <p>To configure the maximum certificate chain depth for MNR links, enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# multi-node-routing
solace(configure/routing/multi-node-routing)# cspf
solace(...igure/routing/multi-node-routing/cspf)# ssl
solace(...e/routing/multi-node-routing/cspf/ssl)# certificate-validation
solace(...uting/cspf/ssl/certificate-validation)#  max-certificate-chain-depth &lt;max-depth&gt;</pre>
    <p><u>Where</u>:</p>
    <p><code>&lt;max-depth&gt;</code> is a number from 0 to 8 specifying the maximum number of signing CA certificates that may be present in the certificate chain. The default value is 3.</p>
    <p>The no version of these commands, <code>no max-certificate-chain-depth</code>, resets this parameter to its default value.</p>
    <h4><a name="Cert-Dates"/>Validate Certificate Dates</h4>
    <p>Certificates may specify "not before" and "not after" dates to provide a time range for which they will be valid. This setting will enable or disable the validation of these dates. If this check is disabled, the event broker will accept a certificate even if the valid date range provided in the certificate is not fulfilled. By default, validation of certificate dates is enabled.</p>
    <p>To enable validation of certificate dates MNR links, enter the following commands:</p>
    <pre>solace(configure)# routing
solace(configure/routing)# multi-node-routing
solace(configure/routing/multi-node-routing)# cspf
solace(...igure/routing/multi-node-routing/cspf)# ssl
solace(...e/routing/multi-node-routing/cspf/ssl)# certificate-validation
solace(...uting/cspf/ssl/certificate-validation)#  validate-certificate-date</pre>
    <p>The no version of these commands, <code>no validate-certificate-date</code>, disables validation of the  certificate dates.</p>
    <h2 class="with-rule"><a name="Viewing"/>Viewing MNR Information</h2>
    <p>You can use the following show commands to view MNR information.</p>
    <h3><a name="managing_multi-node_routing_links_975483870_201309"/>Showing CSPF Neighbor Link Information</h3>
    <p>To show the configuration and state of CSPF neighbor links on the event broker, enter the following command:</p>
    <pre>solace&gt; show cspf neighbor &lt;physical-router-name&gt; [stats [queues | detail] | connections [wide] | detail]</pre>
    <p><u>Where</u>:</p>
    <p><code>&lt;physical-router-name&gt;</code> is the name of the neighbor event broker. This name cannot begin with “v:”, as that indicates a virtual router.</p>
    <p><code>stats</code> asks to show basic dataplane statistics on messages for the specified neighbor.</p>
    <p><code>queues</code> asks to show dataplane statistics on queued messages for the specified neighbor.</p>
    <p><code>detail</code> asks to show detailed dataplane statistics on messages for the specified neighbor.</p>
    <p><code>connections</code> asks to show TCP connection status information between the specified neighbor.</p>
    <p><code>connections wide</code> asks to show detailed TCP connection status information between neighbors in a wide-screen computer display format (300+ character width).</p>
    <p><code>detail</code> asks to show detailed information on the configuration and state of CSPF links.</p>
    <h4>Clearing CSPF Neighbor Link Stats</h4>
    <p>To clear CSPF message statistics related to neighbor links, enter the following commands:</p>
    <pre>solace&gt; enable
solace# clear cspf neighbor &lt;physical-router-name&gt; stats</pre>
    <p><u>Where</u>:</p>
    <p><code>&lt;physical-router-name&gt;</code> is the name of the neighbor event broker. This name cannot begin with “v:”, as that indicates a virtual router.</p>
    <p>When this command is entered, all of the CSPF message statistics are reset to 0, and CSPF statistics begin to be recorded again from this point.</p>
    <h3><a name="managing_multi-node_routing_links_975483870_220281"/>Showing SMRP Subscription Info</h3>
    <p>To view SMRP subscription information on the event broker, enter the following command:</p>
    <pre>solace&gt; show smrp subscriptions [message-vpn &lt;vpn-name&gt;] [destination-name &lt;destination-name&gt;] [remote-router] [client] [queue] [topic-endpoint] [primary] [backup] [static] [{[dto-priority &lt;priority&gt;] [topic &lt;topic-str&gt;] [persistent] [non-persistent]} | {summary}]</pre>
    <p><u>Where</u>:</p>
    <p><code>message-vpn</code> asks to display only the SMRP subscriptions for the specified Message VPN, <code>&lt;vpn-name&gt;</code>. The given Message VPN name can be its full name, or part of its name with the wildcard character ? used to represent one character of the name, or the wildcard character * used to represent zero or more characters of the name. Entering only the wildcard character * for the name displays all Message VPNs.</p>
    <p><code>destination-name</code> asks to display only the SMRP subscriptions to the specified destination, <code>&lt;destination-name&gt;</code>. The given destination name can be the full name of the destination, or part of the destination name with the wildcard character ? used to represent one character of the name, or the wildcard character * used to represent zero or more characters of the name. Entering only the wildcard character * for the name displays all destinations.</p>
    <p><code>remote-router</code> asks to display only the SMRP subscriptions to remote event brokers.</p>
    <p><code>client</code> asks to display only the SMRP subscriptions to local clients.</p>
    <p><code>queue</code> asks to display only the SMRP subscriptions to local queues.</p>
    <p><code>topic-endpoint</code> asks to display only the SMRP subscriptions to local topic-endpoints.</p>
    <p><code>primary</code> asks to display only the SMRP subscriptions to primary local destinations.</p>
    <p><code>backup</code> asks to display only the SMRP subscriptions to backup local destinations</p>
    <p><code>static</code> asks to display only the SMRP subscriptions to static local destinations.</p>
    <p><code>&lt;priority&gt;</code> asks to display SMRP subscriptions for only the specified Deliver-To-One (DTO) client priority level. Valid values are P1, P2, P3, P4, or DA (for Delivery Always).</p>
    <p><code>topic</code> asks to display SMRP subscriptions for a topic subscription string, <code>topic-str</code>. The given topic subscription string must be in the form <code>a/b/c</code>.</p>
    <p><code>persistent</code> asks to display only the SMRP subscriptions tor persistent topics.</p>
    <p><code>non-persistent</code> asks to display only the SMRP subscriptions to non-persistent topics.</p>
    <p><code>summary</code> asks to show the number of SMRP subscriptions for each destination.</p>
    <p class="Note">In addition to Solace Message Format (SMF) topic subscriptions, the <code>show smrp subscriptions</code> User EXEC command may also display Message Queuing Telemetry Transport (MQTT) topic subscriptions. Because this command must be able to represent both SMF and MQTT topic syntax, if a topic subscription uses characters with special meaning for the topic syntax it uses (for example, wildcards), those characters may be displayed in the output as escaped characters.</p>
    <p>The direct messaging health check could be used with the appliance and a load-balancer to horizontally scale direct messaging.</p>
    <h2 class="with-rule"><a name="Subscrip"/>Prevention of Subscription Propagation Race Conditions </h2>
    <p>If you're doing Request/Reply messaging with MNR, you must use the Request/Reply methods of the Solace APIs to prevent possible race conditions associated with subscription propagation. More specifically, you must use the built-in Request/Reply topic (an internal P2P topic by default). If you set the <code>ReplyTo</code>  to a custom value, there will  be subscription delays and the possibility of a subscription propagation race condition.</p>
    <p>For more information on Request/Reply messaging refer to <MadCap:xref href="../../API/API-Developer-Guide/Request-Reply-Messaging.htm">Request Reply Messaging</MadCap:xref>.</p>
    <p>For more information on Solace APIs refer to <MadCap:xref href="../../API/Messaging-APIs/Solace-APIs-Overview.htm">APIs &amp; Protocols</MadCap:xref>.</p>
  </body>
</html>
