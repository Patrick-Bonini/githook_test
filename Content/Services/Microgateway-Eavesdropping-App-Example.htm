<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
  <head/>
  <body>
    <h1>Eavesdropping Application Example</h1>
    <p>The following sections provide an example of how to add an eavesdropping application to an existing Microgateway deployment with the Solace CLI.</p>
    <ul>
      <li>
        <MadCap:xref href="#Create_Queue">Step 1: Create a Queue for the Eavesdropping Application </MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#Add_Sub">Step 2: Add Topic Subscriptions to the Queue</MadCap:xref>
      </li>
      <li>
        <MadCap:xref href="#Enable_Queue">Step 3: Enable the Queue</MadCap:xref>
      </li>
    </ul>
    <h2 class="with-rule"><a name="Assumpti"/>Before you begin</h2>
    <p>The example provided in the following sections assumes that the following parameters are already configured on the Solace PubSub+ event broker:</p>
    <ul>
      <li>Client authentication and authorization settings for the eavesdropping application to connect to the Message VPN used in the Microgateway deployment. For details, refer to <MadCap:xref href="../Security/Client-Authentication.htm">Client Authentication</MadCap:xref> and <MadCap:xref href="../Security/Client-Authorization.htm">Client Authorization</MadCap:xref>.</li>
      <li>All components of the  Microgateway deployment. For details, refer to <MadCap:xref href="Managing-Microgateway.htm">Microgateway Configuration</MadCap:xref>.</li>
    </ul>
    <h2 class="with-rule"><a name="Create_Queue"/>Step 1: Create a Queue for the Eavesdropping Application </h2>
    <p>When you add an eavesdropping application to a Microgateway deployment, Solace recommends that you create a separate queue to receive, store, and deliver messages for the application. This allows you to handle message persistence with more flexibility, and provides greater control over the selection of requests and responses you want directed to the application, without interfering with the service configuration.</p>
    <p>In this example, a dedicated queue (Queue B) is created for the eavesdropping application, and the application is permitted to read and delete messages from it. </p>
    <p>
      <img src="../Resources/Images/Microgateway-Tasks/microgateway-eavesdropping-queue2.PNG" style="max-width: 750px;" alt=""/>
    </p>
    <p class="Code">solace(configure)# message-spool message-vpn rest-microgateway<br/>solace(configure/message-spool)# create queue B<br/>solace(configure/message-spool/queue)# permission all consume</p>
    <h2 class="with-rule"><a name="Add_Sub"/>Step 2: Add Topic Subscriptions to the Queue</h2>
    <p>In order for the eavesdropping application to receive requests and responses propagated by the Microgateway, you must add the following types of topic subscriptions to the queue:</p>
    <ul>
      <li>One or more subscriptions that match  existing subscriptions used to receive requests from REST clients. </li>
      <li>One or more subscriptions that correspond with the reply-to topics generated by the event broker. These topics are generated according to the following format: <code>#P2P/&lt;virtual-router-name&gt;/_rest-&lt;tsid&gt;/&lt;request-method&gt;/&lt;request-path&gt;</code>.</li>
    </ul>
    <p>In this example, two topic subscriptions are added to the queue. The first matches the subscription used in the existing deployment to attract incoming requests from the REST client, and the second attracts all responses from the remote microservice. </p>
    <p>
      <img src="../Resources/Images/Microgateway-Tasks/microgateway-eavesdropping-sub2.PNG" style="max-width: 750px;" alt=""/>
    </p>
    <p class="Code">solace(configure/message-spool/queue)# subscription topic GET/store/orders<br/>solace(configure/message-spool/queue)# subscription topic #P2P/v:solace/_rest-*/&gt;</p>
    <h2 class="with-rule"><a name="Enable_Queue"/>Step 3: Enable the Queue</h2>
    <p>Before  the queue  can process requests, you must enable it. Once the queue is enabled, you can configure the eavesdropping application to connect to it in order to retrieve and process the stored requests and responses. </p>
    <p>
      <img src="../Resources/Images/Microgateway-Tasks/microgateway-eavesdropping-enable2.PNG" style="max-width: 750px;" alt=""/>
    </p>
    <p class="Code">solace(configure/message-spool/queue)# no shutdown</p>
  </body>
</html>
